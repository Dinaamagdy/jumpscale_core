#! /usr/bin/env python3
import sys
import requests
from js9 import j

base_repo_url = 'https://github.com/Jumpscale/%s%s'
branch_query_url = '%s/tree/%%s' % base_repo_url

def branch_exist(repo, branch):
    """
    Checks if a branch exist in a git repository
    """
    url = branch_query_url % (repo, '', branch)
    response = None
    try:
        response = requests.api.get(url)
        if response.status_code != 200:
            return False
    except Exception:
        pass
    if response is None:
        return False
    return True

print(j.do.mascot)

if j.do.exists('/optvar/private/pubsshkeys/id_rsa'):
    j.clients.ssh.SSHKeysLoad('/optvar/private/pubsshkeys/id_rsa')

no_init = True
if 'noinit' in sys.argv:
    no_init = False
    sys.argv.pop()


branch = ''
if len(sys.argv) > 1:
    branch = sys.argv[-1]

if not (branch and branch_exist(repo='portal9', branch=branch)):
    branch = 'master'

j.clients.git.pullGitRepo("git@github.com:Jumpscale/portal9.git", branch=branch)


path = "%s/github/jumpscale/portal9" % j.dirs.CODEDIR
j.do.execute("cd %s;sh install.sh" % path)

if no_init is False:
    print("* init jumpscale 9")
    j.do.execute("js9_init")
